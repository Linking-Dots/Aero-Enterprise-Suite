import{J as Qe,j as r,a as c,b as ce,Q as Ke}from"./app-CqbLl2Kt.js";import{r as l}from"./react-core-DDvupgOx.js";import{G as ue}from"./logo-Df0pOkCJ.js";import{P as Ve}from"./PageHeader-dNWjWXG9.js";import{S as We}from"./StatsCards-C3HP-wMJ.js";import{B as T,e as He,f as Z,A as Je}from"./App-Drug6pRE.js";import{L as me,D as Xe,B as Ze,a as Ue,b as ea}from"./BulkDeleteModal-QqbnuKSU.js";import{d as pe}from"./dayjs.min-WGrXCzEl.js";import{a as q}from"./utilities-DT6SRl8s.js";import{u as aa,a as ve,T as S,B as he,G as ta,F as ra,f as sa}from"./mui-libraries-DIRJRVmP.js";import{F as la}from"./CheckCircleIcon-CJUGb5Jf.js";import{F as oa}from"./XCircleIcon-DJR5_Dv7.js";import{F as ge}from"./ChartBarIcon-Yugn57JF.js";import{F as fe}from"./ExclamationTriangleIcon-C_gcLnRy.js";import{F as na}from"./MagnifyingGlassIcon-yCnY2aj3.js";import{F as ia}from"./AdjustmentsHorizontalIcon-DKS_UuIh.js";import{F as da}from"./PlusIcon-AKF5lePL.js";import{F as ca}from"./DocumentArrowDownIcon-Cq-JO3FQ.js";import{F as ua}from"./PresentationChartLineIcon-B_Z8Hogu.js";import{e as K,i as be,D as ma,b as pa,s as U,l as D,f as V,g as ee}from"./ui-libraries-CxFzkmxb.js";import"./EnvelopeIcon-D6nUSkik.js";import"./UserIcon-D16nn9o_.js";import"./ShieldCheckIcon-C7bFKizx.js";import"./TrashIcon-D8Us3Tf_.js";import"./PencilIcon-Dhfhztfv.js";import"./EllipsisVerticalIcon-BX6PWMxg.js";import"./XCircleIcon-StDWd-mv.js";import"./CheckCircleIcon-DnGOlVla.js";import"./ClockIcon-DNQ3nlJB.js";import"./ExclamationTriangleIcon-CsS6HvBt.js";import"./HeartIcon-BSdzzFKC.js";import"./Clear-Cf7uwVG0.js";import"./GlassDialog-DaqLouy3.js";import"./LoadingButton-B1uvELc3.js";import"./InformationCircleIcon-BNRxDcw3.js";const va=({title:W,allUsers:k})=>{const{auth:R}=Qe().props,M=aa(),G=ve(M.breakpoints.down("sm"));ve(M.breakpoints.down("md"));const[ye,H]=l.useState(!1),[N,B]=l.useState([]),[u,p]=l.useState(),[A,v]=l.useState(0),[we,_]=l.useState(0),[ae,te]=l.useState(),[ke,re]=l.useState([]),[se,j]=l.useState(""),[le,_e]=l.useState([]),[d,P]=l.useState({perPage:30,currentPage:1}),[ha,x]=l.useState(!1),[Q,Pe]=l.useState(!1),[a,Ce]=l.useState({employee:"",selectedMonth:pe().format("YYYY-MM"),status:[],leaveType:[],department:[]}),h=l.useCallback((e,t)=>{if(e==="year"){const s=Number(t);if(s<1900||s>new Date().getFullYear()){console.warn("Invalid year selected. Must be between 1900 and current year.");return}}Ce(s=>({...s,[e]:t})),P(s=>({...s,currentPage:1}))},[]),[E,Le]=l.useState({pending:0,approved:0,rejected:0,total:0}),O=R.permissions?.includes("leaves.view")||!1,z=R.permissions?.includes("leaves.approve")||!1,oe=R.permissions?.includes("leaves.create")||!1,Se=R.permissions?.includes("leaves.update")||!1,Ae=R.permissions?.includes("leaves.delete")||!1,Me=l.useMemo(()=>{const e=[{key:"all",label:"All Types",value:"all"}];if(!N.leaveTypes)return e;const t=N.leaveTypes.map(s=>({key:s.type.toLowerCase(),label:s.type,value:s.type.toLowerCase()}));return[...e,...t]},[N.leaveTypes]),Ne=l.useCallback(e=>{$(t=>({...t,[e]:!0}))},[]),xe=l.useCallback((e,t)=>{te({id:e}),$(s=>({...s,[t]:!0}))},[]);l.useCallback(e=>{h("employee",e.target.value.toLowerCase())},[h]);const J=l.useCallback(e=>{h("selectedMonth",e.target.value)},[h]),Fe=l.useCallback(e=>{P(t=>({...t,currentPage:e}))},[]),Te=l.useCallback(e=>{P(t=>({...t,perPage:e,currentPage:1}))},[]),g=l.useCallback(async(e=null,t=null)=>{H(!0);const s=e||d.currentPage,i=t||d.perPage;try{const o=await q.get(route("leaves.paginate"),{params:{page:s,perPage:i,employee:a.employee,month:a.selectedMonth,status:Array.isArray(a.status)&&a.status.length>0?a.status:void 0,leave_type:Array.isArray(a.leaveType)&&a.leaveType.length>0?a.leaveType:void 0,department:Array.isArray(a.department)&&a.department.length>0?a.department:void 0,admin_view:!0,view_all:!0}});if(o.status===200){const{leaves:n,leavesData:L,departments:m}=o.data;n?.data&&Array.isArray(n.data)?(p(n.data),v(n.total||n.data.length),_(n.last_page||1),e&&e!==d.currentPage&&P(f=>({...f,currentPage:e})),t&&t!==d.perPage&&P(f=>({...f,perPage:t}))):Array.isArray(n)?(p(n),v(n.length),_(1)):(console.error("Unexpected leaves data format:",n),p([]),v(0),_(1)),B(L),_e(m||[]),j("")}}catch(o){if(console.error("Error fetching leaves data:",o.response),o.response?.status===404){const{leavesData:n}=o.response.data||{};B(n||[]),j(o.response?.data?.message||"No leaves found for the selected criteria.")}else j(o.response?.data?.message||"Error retrieving leaves data. Please try again.");p([]),v(0),_(1)}finally{H(!1)}},[a,d.currentPage,d.perPage]),C=l.useCallback(async()=>{try{const e=await q.get(route("leaves.stats"),{params:{month:a.selectedMonth,admin_view:!0,view_all:!0}});if(e.status===200){const{stats:t}=e.data;Le(t)}}catch(e){console.error("Error fetching leaves data:",e.response),e.response?.status===404?j(e.response?.data?.message||"No leaves found for the selected criteria."):j("Error retrieving leaves data. Please try again."),H(!1)}},[a]),De=l.useCallback(async e=>{if(z)try{if((await q.post(route("leaves.bulk-approve"),{leave_ids:e})).status===200){g();const s=Promise.resolve();T.promise(s,{success:"Selected leaves approved successfully"})}}catch(t){console.error("Error bulk approving leaves:",t);const s=Promise.reject(t);T.promise(s,{error:"Failed to approve selected leaves"})}},[z,g]),Re=l.useCallback(async e=>{if(z)try{if((await q.post(route("leaves.bulk-reject"),{leave_ids:e})).status===200){g();const s=Promise.resolve();T.promise(s,{success:"Selected leaves rejected successfully"})}}catch(t){console.error("Error bulk rejecting leaves:",t);const s=Promise.reject(t);T.promise(s,{error:"Failed to reject selected leaves"})}},[z,g]),Be=l.useCallback(e=>{re(e),$(t=>({...t,bulk_delete:!0}))},[]),je=l.useMemo(()=>[{title:"Pending",value:E.pending,icon:r(He,{}),color:"text-orange-400",iconBg:"bg-orange-500/20",description:"Awaiting approval"},{title:"Approved",value:E.approved,icon:r(la,{}),color:"text-green-400",iconBg:"bg-green-500/20",description:"Successfully approved"},{title:"Rejected",value:E.rejected,icon:r(oa,{}),color:"text-red-400",iconBg:"bg-red-500/20",description:"Declined requests"},{title:"Total",value:E.total,icon:r(ge,{}),color:"text-blue-400",iconBg:"bg-blue-500/20",description:"All leave requests"}],[E]);if(!O)return r(he,{sx:{display:"flex",justifyContent:"center",p:2},children:r(ue,{children:c(K,{className:"p-8 text-center",children:[r(fe,{className:"w-16 h-16 text-warning-500 mx-auto mb-4"}),r(S,{variant:"h6",className:"mb-2",children:"Access Denied"}),r(S,{variant:"body2",color:"textSecondary",children:"You don't have permission to view leave management."})]})})});const[b,$]=l.useState({add_leave:!1,edit_leave:!1,delete_leave:!1,bulk_leave:!1,bulk_delete:!1}),Ee=l.useRef(null),ne=l.useCallback(e=>{$(t=>({...t,[e]:!0}))},[]),Y=l.useCallback(e=>{$(t=>({...t,[e]:!1})),e==="bulk_delete"&&re([])},[]),ie=l.useCallback(e=>[...e].sort((t,s)=>new Date(s.from_date)-new Date(t.from_date)),[]),I=l.useCallback((e,t=null)=>{v(e);const s=Math.max(1,Math.ceil(e/d.perPage));_(s),d.currentPage>s&&P(i=>({...i,currentPage:s}))},[d.perPage,d.currentPage]),de=l.useCallback(e=>{const t=pe(e.from_date).format("YYYY-MM");if(a.selectedMonth&&t!==a.selectedMonth)return!1;if(a.employee){const s=k?.find(o=>String(o.id)===String(e.user_id)),i=a.employee.trim().toLowerCase();if(s){if(String(s.id)!==i&&!(s.name&&s.name.trim().toLowerCase().includes(i)))return!1}else if(String(a.employee)!==String(e.user_id))return!1}if(Array.isArray(a.status)&&a.status.length>0&&!a.status.some(i=>String(e.status).toLowerCase()===String(i).toLowerCase())||Array.isArray(a.leaveType)&&a.leaveType.length>0&&!a.leaveType.some(i=>String(e.leave_type).toLowerCase()===String(i).toLowerCase()))return!1;if(Array.isArray(a.department)&&a.department.length>0){const s=k?.find(o=>String(o.id)===String(e.user_id));if(!s||!a.department.some(o=>String(s.department_id)===String(o)))return!1}return!0},[a,k]),Oe=l.useMemo(()=>u||[],[u]),X=l.useCallback(async()=>{if(u&&u.length<d.perPage&&A>u.length){const e=Math.min(d.perPage-u.length,A-u.length);if(e<=0)return;x(!0);try{const t=await q.get(route("leaves.paginate"),{params:{page:d.currentPage+1,perPage:e,employee:a.employee,month:a.selectedMonth,status:Array.isArray(a.status)&&a.status.length>0?a.status:void 0,leave_type:Array.isArray(a.leaveType)&&a.leaveType.length>0?a.leaveType:void 0,department:Array.isArray(a.department)&&a.department.length>0?a.department:void 0,admin_view:!0,view_all:!0}});t.status===200&&t.data.leaves.data&&p(s=>{const i=t.data.leaves.data.filter(de),o=[...s,...i];return ie(o)})}catch(t){const s=Promise.reject(t);T.promise(s,{error:"Error fetching additional items."}),console.error(`Error fetching additional items from page ${d.currentPage+1}:`,t)}finally{x(!1)}}},[d.currentPage,d.perPage,u,a,ie,de]),y=l.useCallback((e,t)=>{if(!t||!t.success){console.error(`Invalid ${e} response data:`,t);return}C(),t.leavesData&&B(t.leavesData);const s=d.perPage,i=d.currentPage;switch(e){case"bulk_delete":{const o=t.deleted_leaves||[],n=t.deleted_count||o.length;if(n===0)return;const L=o.map(w=>w.id),m=Math.max(0,A-n),f=u.filter(w=>!L.includes(w.id)).length;if(n>5||f===0||i>1&&f<s/2){const w=Math.ceil(m/s);let F=i;f===0&&m>0?F=Math.max(1,i-1):i>w&&w>0&&(F=w),P(Ge=>({...Ge,currentPage:F})),g(F,s)}else x(!0),p(w=>w.filter(F=>!L.includes(F.id))),v(m),I(m),x(!1),X();break}case"single_delete":{const o=t.deleted_leave_id;if(!o)return;const n=Math.max(0,A-1);if(u.filter(m=>m.id!==o).length===0&&n>0&&i>1){const m=i-1;P(f=>({...f,currentPage:m})),g(m,s)}else x(!0),p(m=>m.filter(f=>f.id!==o)),v(n),I(n),x(!1),X();break}case"bulk_add":case"single_add":{const o=t.added_count||1,n=A+o;e==="bulk_add"||u.length<s?(v(n),I(n),g(i,s)):(v(n),I(n));break}case"edit":{const o=t.updated_leave||t.leave;o&&p(n=>n.map(L=>L.id===o.id?o:L));break}}},[d.perPage,d.currentPage,A,u,C,I,g,X]),ze=l.useCallback(e=>{y("single_add",{success:!0,added_count:1,leave:e})},[y]),$e=l.useCallback(e=>{y("edit",{success:!0,updated_leave:e});const s=Promise.resolve(["Leave updated!"]);T.promise(s,{success:{render({data:i}){return r(ce,{children:i.map((o,n)=>r("div",{children:o},n))})},icon:"ðŸŸ¢",style:{backdropFilter:"blur(16px) saturate(200%)",background:M.glassCard.background,border:M.glassCard.border,color:M.palette.text.primary}}})},[g,C,M]),Ye=l.useCallback(e=>{if(!e||!e.success){console.error("Invalid bulk response data:",e);return}const t=e.created_leaves||[],s=e.summary?.successful||t.length,i={...e,added_count:s};y("bulk_add",i)},[y]),Ie=l.useCallback(e=>{y("single_delete",{success:!0,deleted_leave_id:e})},[y]),qe=l.useCallback(e=>{y("bulk_delete",e)},[y]);return l.useEffect(()=>{O&&g()},[g,O,d.currentPage,a.employee,a.selectedMonth,a.status,a.leaveType,a.department]),l.useEffect(()=>{O&&C()},[g,O]),c(ce,{children:[r(Ke,{title:W}),b.add_leave&&r(me,{open:b.add_leave,closeModal:()=>Y("add_leave"),leavesData:N,setLeavesData:B,currentLeave:null,allUsers:k,setTotalRows:v,setLastPage:_,setLeaves:p,handleMonthChange:J,employee:a.employee,selectedMonth:a.selectedMonth,addLeaveOptimized:ze,fetchLeavesStats:C}),b.edit_leave&&r(me,{open:b.edit_leave,closeModal:()=>Y("edit_leave"),leavesData:N,setLeavesData:B,currentLeave:ae,allUsers:k,setTotalRows:v,setLastPage:_,setLeaves:p,handleMonthChange:J,employee:a.employee,selectedMonth:a.selectedMonth,updateLeaveOptimized:$e,fetchLeavesStats:C}),b.delete_leave&&r(Xe,{open:b.delete_leave,closeModal:()=>Y("delete_leave"),leaveId:ae?.id,setLeaves:p,setTotalRows:v,setLastPage:_,deleteLeaveOptimized:Ie,fetchLeavesStats:C}),b.bulk_leave&&r(Ze,{open:b.bulk_leave,onClose:()=>Y("bulk_leave"),onSuccess:e=>{Ye(e)},allUsers:k,leavesData:N,isAdmin:!0}),b.bulk_delete&&r(Ue,{open:b.bulk_delete,onClose:()=>Y("bulk_delete"),onSuccess:e=>{qe(e)},selectedLeaves:ke,allUsers:k}),r(he,{sx:{display:"flex",justifyContent:"center",p:2},children:r(ta,{in:!0,children:r(ue,{children:r(Ve,{title:"Leave Management",subtitle:"Manage employee leave requests and approvals",icon:r(ua,{className:"w-8 h-8"}),variant:"gradient",actionButtons:[...oe?[{label:"Add Leave",icon:r(da,{className:"w-4 h-4"}),onPress:()=>ne("add_leave"),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"}]:[],...oe?[{label:"Add Bulk",icon:r(Z,{className:"w-4 h-4"}),onPress:()=>ne("bulk_leave"),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"}]:[],{label:"Export",icon:r(ca,{className:"w-4 h-4"}),variant:"bordered",className:"border-[rgba(var(--theme-primary-rgb),0.3)] bg-[rgba(var(--theme-primary-rgb),0.05)] hover:bg-[rgba(var(--theme-primary-rgb),0.1)]"}],children:c("div",{className:"p-6",children:[r(We,{stats:je}),c("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[r("div",{className:"flex-1",children:r(be,{label:"Search Employee",variant:"bordered",placeholder:"Search by name or ID...",value:a.employee,onValueChange:e=>h("employee",e),startContent:r(na,{className:"w-4 h-4"}),classNames:{input:"bg-transparent",inputWrapper:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},size:G?"sm":"md"})}),r("div",{className:"flex gap-2 items-end",children:r(ma,{variant:"bordered",className:"bg-white/5",children:c(pa,{isIconOnly:G,color:Q?"primary":"default",onPress:()=>Pe(!Q),className:Q?"bg-purple-500/20":"bg-white/5",children:[r(ia,{className:"w-4 h-4"}),!G&&r("span",{className:"ml-1",children:"Filters"})]})})})]}),Q&&r(ra,{in:!0,timeout:300,children:c("div",{className:"mb-6 p-4 bg-white/5 backdrop-blur-md rounded-lg border border-white/10",children:[c("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[c(U,{label:"Leave Status",selectionMode:"multiple",variant:"bordered",selectedKeys:a.status,onSelectionChange:e=>h("status",Array.from(e)),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},children:[r(D,{value:"pending",children:"Pending"},"pending"),r(D,{value:"approved",children:"Approved"},"approved"),r(D,{value:"rejected",children:"Rejected"},"rejected"),r(D,{value:"new",children:"New"},"new")]}),r(U,{label:"Leave Type",variant:"bordered",selectionMode:"multiple",selectedKeys:a.leaveType,onSelectionChange:e=>h("leaveType",Array.from(e)),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},children:Me.map(e=>r(D,{value:e.value,children:e.label},e.key))}),r(U,{label:"Department",variant:"bordered",selectionMode:"multiple",selectedKeys:a.department,onSelectionChange:e=>h("department",Array.from(e)),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},children:le.map(e=>r(D,{value:e.id,children:e.name},e.id))}),r(be,{label:"Month/Year",type:"month",value:a.selectedMonth,onChange:J,startContent:r(Z,{className:"w-4 h-4"}),variant:"bordered",classNames:{inputWrapper:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},size:G?"sm":"md"})]}),(a.employee||Array.isArray(a.status)&&a.status.length>0||Array.isArray(a.leaveType)&&a.leaveType.length>0||Array.isArray(a.department)&&a.department.length>0)&&c("div",{className:"flex flex-wrap gap-2 mt-4 pt-4 border-t border-white/10",children:[a.employee&&c(V,{variant:"flat",color:"primary",size:"sm",onClose:()=>h("employee",""),children:["Employee: ",a.employee]}),Array.isArray(a.status)&&a.status.map(e=>c(V,{variant:"flat",color:"secondary",size:"sm",onClose:()=>h("status",a.status.filter(t=>t!==e)),children:["Status: ",e]},e)),Array.isArray(a.leaveType)&&a.leaveType.map(e=>c(V,{variant:"flat",color:"warning",size:"sm",onClose:()=>h("leaveType",a.leaveType.filter(t=>t!==e)),children:["Type: ",e]},e)),Array.isArray(a.department)&&a.department.map(e=>{const t=le.find(s=>String(s.id)===String(e));return c(V,{variant:"flat",color:"success",size:"sm",onClose:()=>h("department",a.department.filter(s=>s!==e)),children:["Department: ",t?.name||`ID: ${e}`]},e)})]})]})}),c("div",{className:"min-h-96",children:[c(S,{variant:"h6",className:"mb-4 flex items-center gap-2",children:[r(ge,{className:"w-5 h-5"}),"Leave Requests Management"]}),ye?r(ee,{className:"bg-white/10 backdrop-blur-md border-white/20",children:c(K,{className:"text-center py-12",children:[r(sa,{size:40}),r(S,{className:"mt-4",color:"textSecondary",children:"Loading leave data..."})]})}):u&&u.length>0?r("div",{className:"overflow-hidden rounded-lg",children:r(ea,{ref:Ee,totalRows:A,lastPage:we,setCurrentPage:Fe,setPerPage:Te,perPage:d.perPage,currentPage:d.currentPage,handleClickOpen:xe,setCurrentLeave:te,openModal:Ne,leaves:Oe,allUsers:k,setLeaves:p,employee:a.employee,selectedMonth:a.selectedMonth,isAdminView:!0,onBulkApprove:De,onBulkReject:Re,canApproveLeaves:z,canEditLeaves:Se,canDeleteLeaves:Ae,fetchLeavesStats:C,onBulkDelete:Be})}):se?r(ee,{className:"bg-white/10 backdrop-blur-md border-white/20",children:c(K,{className:"text-center py-12",children:[r(fe,{className:"w-16 h-16 text-warning-500 mx-auto mb-4"}),r(S,{variant:"h6",className:"mb-2",children:"No Data Found"}),r(S,{color:"textSecondary",children:se})]})}):r(ee,{className:"bg-white/10 backdrop-blur-md border-white/20",children:c(K,{className:"text-center py-12",children:[r(Z,{className:"w-16 h-16 text-default-400 mx-auto mb-4"}),r(S,{variant:"h6",className:"mb-2",children:"No Leave Records Found"}),r(S,{color:"textSecondary",children:"No leave records found for the selected criteria."})]})})]})]})})})})})]})};va.layout=W=>r(Je,{children:W});export{va as default};
