import{J as be,j as a,a as u,Q as ye,F as V,b as _e}from"./app-6tTxwSdx.js";import{r as s,s as we,l as Ne,f as Ce,m as M,h as F,g as ke,o as xe}from"./ui-vendor-Dsk9T4EG.js";import{d as W}from"./dayjs.min-DnBP_R1A.js";import{G as Le}from"./logo-D6ASq7aG.js";import{P as Se}from"./PageHeader-DQpNPb28.js";import{B as O,f as B,A as Pe}from"./App-DOWrEKYW.js";import{L as X,D as Me,B as Fe,a as Be,b as Ye}from"./BulkDeleteModal-ByHhFVWO.js";import{a as Z}from"./utils-vendor-DT6SRl8s.js";import{u as Te,a as K,B as De,T as g,f as Re,G as Ae}from"./mui-vendor-gNRFXRd0.js";import{F as ee}from"./ChartBarIcon-CxGuQ1Lj.js";import{F as Ee}from"./XCircleIcon-BzIhfbCY.js";import{F as Ie}from"./PlusIcon-DGUKUTGX.js";import{F as ze}from"./PresentationChartLineIcon-C6twwMYn.js";import"./react-vendor-D8ObPovc.js";import"./animation-vendor-Bzjg6Woq.js";import"./EnvelopeIcon-DpPbvj-t.js";import"./UserIcon-15ugNx-V.js";import"./ShieldCheckIcon-BADfOQX9.js";import"./TrashIcon-Chc7uTQF.js";import"./PencilIcon-CvdIwuPx.js";import"./EllipsisVerticalIcon-BVqep5c4.js";import"./CheckCircleIcon-e9_MXADL.js";import"./ClockIcon-C8Z5Bxc8.js";import"./ExclamationTriangleIcon-Co_AOAo6.js";import"./Clear-Agd1toS9.js";import"./GlassDialog-D9etPuD9.js";import"./LoadingButton-BXM8pXtH.js";import"./InformationCircleIcon-DolSmqSd.js";import"./XCircleIcon-DKf26g1q.js";import"./ExclamationTriangleIcon-DqkpuoTl.js";import"./CheckCircleIcon-CMpNM2Dn.js";const je=({title:E,allUsers:_})=>{const{auth:k}=be().props,$=Te(),x=K($.breakpoints.down("sm")),ae=K($.breakpoints.down("md")),[h,Y]=s.useState(0),[I,T]=s.useState(0),[G,Oe]=s.useState(!1),[y,p]=s.useState([]),[w,N]=s.useState({leaveTypes:[],leaveCountsByUser:{}}),[H,f]=s.useState(!1),[Q,z]=s.useState(""),[l,j]=s.useState({page:1,perPage:30,total:0,lastPage:0}),[i,te]=s.useState({employee:"",selectedMonth:W().format("YYYY-MM"),year:new Date().getFullYear()}),m=s.useCallback(e=>{e&&(Y(e.total||0),T(e.last_page||1),j(r=>({...r,total:e.total||0,lastPage:e.last_page||1})))},[]),v=s.useCallback(async()=>{f(!0);try{const{page:e,perPage:r}=l,{year:t}=i,o=await Z.get(route("leaves.paginate"),{params:{page:e,perPage:r,year:t,user_id:k.user.id},timeout:1e4});if(o.status===200){const{leaves:n,leavesData:d}=o.data;n.data&&Array.isArray(n.data)?(p(n.data),m({total:n.total||n.data.length,last_page:n.last_page||1,current_page:n.current_page||1,per_page:n.per_page||l.perPage})):Array.isArray(n)?(p(n),m({total:n.length,last_page:1,current_page:1,per_page:l.perPage})):(console.error("Unexpected leaves data format:",n),p([]),m({total:0,last_page:1,current_page:1,per_page:l.perPage})),N(d),z("")}}catch(e){if(console.error("Error fetching leaves:",e),e.response?.status===404){const{leavesData:r}=e.response.data;N(r),z(e.response?.data?.message||"No leaves found for the selected criteria.")}else{z("Error retrieving leaves data. Please try again.");const r=Promise.reject("Failed to load leave data. Please try again.");O.promise(r,{error:{render(){return a("div",{children:"Failed to load leave data. Please try again."})},icon:"❌"}})}p([]),m({total:0,last_page:1,current_page:1,per_page:l.perPage})}finally{f(!1)}},[l.page,l.perPage,i,k.user.id,m]),D=s.useCallback((e,r,t)=>{const{page:o,perPage:n}=l;e.length>=n||o<I||v()},[l,I,v]),re=s.useMemo(()=>{const e=new Date().getFullYear();return Array.from({length:e-1900+1},(r,t)=>{const o=1900+t;return{key:o.toString(),label:o.toString(),value:o}}).reverse()},[]),q=s.useCallback((e,r)=>{if(e==="year"){const t=Number(r);if(t<1900||t>new Date().getFullYear()){console.warn("Invalid year selected. Must be between 1900 and current year.");return}}te(t=>({...t,[e]:r})),e==="year"&&j(t=>({...t,page:1}))},[]),[b,R]=s.useState({add_leave:!1,edit_leave:!1,delete_leave:!1,bulk_leave:!1,bulk_delete:!1});s.useCallback((e,r=null)=>{R(t=>({...t,[e]:!0}))},[]);const P=s.useCallback(()=>{R({add_leave:!1,edit_leave:!1,delete_leave:!1,bulk_leave:!1,bulk_delete:!1})},[]),A=s.useCallback(e=>{R(r=>({...r,[e]:!0}))},[]),se=s.useCallback((e,r)=>{U({id:e}),R(t=>({...t,[r]:!0}))},[]),[J,U]=s.useState(null),[le,oe]=s.useState([]),ne=s.useCallback(e=>{U(e)},[]),ie=s.useCallback(e=>{oe(e),A("bulk_delete")},[A]),c=s.useCallback(async()=>{try{const e=await Z.get(route("leaves.stats"),{params:{year:i.year}});if(e.status===200){const{stats:r,leaveCounts:t}=e.data;t&&N(o=>({...o,leaveCountsByUser:{...o.leaveCountsByUser,[k.user.id]:t}}))}}catch(e){console.error("Error fetching leaves stats:",e.response)}},[i.year,k.user.id]),ce=s.useCallback(e=>{e!==l.page&&j(r=>({...r,page:e}))},[l.page]);s.useEffect(()=>{v()},[v]),s.useEffect(()=>{c()},[c]);const de=s.useMemo(()=>w.leaveCountsByUser[k.user.id]||[],[w.leaveCountsByUser,k.user.id]),L=s.useCallback(e=>[...e].sort((r,t)=>new Date(r.from_date)-new Date(t.from_date)),[]),C=s.useCallback(e=>{const r=new Date(e.from_date).getFullYear();if(i.year&&r!==i.year)return!1;if(i.employee){const t=_?.find(n=>String(n.id)===String(e.user_id)),o=i.employee.trim().toLowerCase();if(t){if(String(t.id)!==o&&!(t.name&&t.name.trim().toLowerCase().includes(o)))return!1}else if(String(i.employee)!==String(e.user_id))return!1}if(i.selectedMonth&&W(e.from_date).format("YYYY-MM")!==i.selectedMonth||i.status&&i.status!=="all"&&String(e.status).toLowerCase()!==String(i.status).toLowerCase()||i.leaveType&&i.leaveType!=="all"&&String(e.leave_type).toLowerCase()!==String(i.leaveType).toLowerCase())return!1;if(i.department&&i.department!=="all"){const t=_?.find(o=>String(o.id)===String(e.user_id));if(!t||String(t.department).toLowerCase()!==String(i.department).toLowerCase())return!1}return!0},[i,_]);s.useMemo(()=>y||[],[y]);const ue=s.useCallback(e=>{C(e)&&(f(!0),p(r=>{const t=[...r,e];return L(t).slice(0,l.perPage)}),m({total:h+1,last_page:Math.ceil((h+1)/l.perPage),current_page:l.page,per_page:l.perPage}),f(!1),l.page!==1&&v(),c())},[C,L,l,h,m,v,c]),me=s.useCallback(e=>{if(!e||!e.success){console.error("Invalid bulk response data:",e);return}e.leavesData&&N(e.leavesData);const r=e.created_leaves||[];if(r.length===0){c();return}const t=r.filter(n=>C(n));if(t.length===0){c();return}f(!0),p(n=>{const d=[...n,...t];return L(d).slice(0,l.perPage)});const o=e.summary?.successful||r.length;m({total:h+o,last_page:Math.ceil((h+o)/l.perPage),current_page:l.page,per_page:l.perPage}),f(!1),l.page!==1&&v(),c()},[C,L,l,h,m,v,c]),pe=s.useCallback(e=>{const r=y.some(o=>o.id===e.id);if(f(!0),!C(e)&&r){p(n=>n.filter(d=>d.id!==e.id));const o=Promise.resolve();O.promise(o,{success:{render(){return a("div",{children:"Leave removed from filtered view."})},icon:"ℹ️"}}),f(!1);return}if(!r&&!C(e)){f(!1);return}p(o=>{const n=o.some(S=>S.id===e.id);let d;return n?d=o.map(S=>S.id===e.id?e:S):d=[...o,e],L(d).slice(0,l.perPage)});const t=Promise.resolve();O.promise(t,{success:{render(){return a("div",{children:"Leave updated!"})},icon:"✅"}}),f(!1),l.page!==1&&v(),c()},[C,L,y,l,v,c]),ge=s.useCallback(e=>{p(t=>{const o=t.filter(d=>d.id!==e),n=Math.max(0,h-1);return D(o,n,"delete"),o});const r=Math.max(0,h-1);m({total:r,last_page:Math.max(1,Math.ceil(r/l.perPage)),current_page:l.page,per_page:l.perPage}),c()},[c,h,l,m,D]),he=s.useCallback(e=>{if(!e||!e.success){console.error("Invalid bulk delete response data:",e);return}e.leavesData&&N(e.leavesData);const r=e.deleted_leaves||[],t=r.map(d=>d.id);if(t.length===0){c();return}f(!0),p(d=>d.filter(S=>!t.includes(S.id)));const o=e.deleted_count||r.length,n=Math.max(0,h-o);m({total:n,last_page:Math.max(1,Math.ceil(n/l.perPage)),current_page:l.page,per_page:l.perPage}),f(!1),D(y.filter(d=>!t.includes(d.id)),n,"delete"),c()},[m,l,h,y,D,c]),fe=()=>w.leaveTypes.length?a("div",{className:`grid gap-4 ${x?"grid-cols-1":ae?"grid-cols-2":"grid-cols-4"}`,children:w.leaveTypes.map(({type:e})=>{const r=de.find(d=>d.leave_type===e)||{},t=r.days_used||0,o=r.remaining_days||0,n=t+o;return u(M,{className:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15 transition-all duration-200",children:[a(ke,{className:"pb-2",children:u("div",{className:"flex items-center gap-2",children:[a(B,{className:"w-5 h-5"}),a(g,{variant:x?"subtitle1":"h6",className:"font-semibold truncate",children:e})]})}),a(F,{className:"pt-0",children:u("div",{className:"space-y-3",children:[u("div",{className:"flex justify-between items-center",children:[u("div",{className:"text-center",children:[a(g,{variant:"caption",color:"textSecondary",children:"Used"}),a(g,{variant:x?"h6":"h5",className:"font-bold text-red-400",children:t})]}),a(xe,{orientation:"vertical",className:"h-8"}),u("div",{className:"text-center",children:[a(g,{variant:"caption",color:"textSecondary",children:"Remaining"}),a(g,{variant:x?"h6":"h5",className:"font-bold text-green-400",children:o})]})]}),n>0&&a("div",{className:"w-full bg-gray-200 rounded-full h-2",children:a("div",{className:"bg-gradient-to-r from-red-400 to-orange-400 h-2 rounded-full transition-all duration-300",style:{width:`${t/n*100}%`}})})]})})]},e)})}):a(M,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(F,{className:"text-center py-8",children:[a(ee,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),a(g,{variant:"body1",color:"textSecondary",children:"No leave types available"})]})}),ve=s.useRef(null);return u(_e,{children:[a(ye,{title:E}),b.add_leave&&a(X,{open:b.add_leave,closeModal:()=>P(),leavesData:w,setLeavesData:N,currentLeave:null,allUsers:_,setTotalRows:Y,setLastPage:T,setLeaves:p,employee:"",selectedMonth:i.selectedMonth,addLeaveOptimized:ue,updatePaginationMetadata:m,fetchLeavesStats:c}),b.edit_leave&&a(X,{open:b.edit_leave,closeModal:()=>P(),leavesData:w,setLeavesData:N,currentLeave:J,allUsers:_,setTotalRows:Y,setLastPage:T,setLeaves:p,employee:"",selectedMonth:i.selectedMonth,updateLeaveOptimized:pe,updatePaginationMetadata:m,fetchLeavesStats:c}),b.delete_leave&&a(Me,{open:b.delete_leave,closeModal:()=>P(),leaveId:J?.id,setLeaves:p,setTotalRows:Y,setLastPage:T,deleteLeaveOptimized:ge,updatePaginationMetadata:m,fetchLeavesStats:c}),b.bulk_leave&&a(Fe,{open:b.bulk_leave,onClose:()=>P(),onSuccess:e=>{me(e)},allUsers:_,leavesData:w,isAdmin:!1,existingLeaves:y||[],publicHolidays:w?.publicHolidays||[]}),b.bulk_delete&&a(Be,{open:b.bulk_delete,onClose:()=>P(),onSuccess:e=>{he(e)},selectedLeaves:le,allUsers:_}),u(De,{sx:{display:"flex",justifyContent:"center",p:2},children:["        ",a(Ae,{in:!0,children:a(Le,{children:a(Se,{title:"My Leaves",subtitle:"Your leave requests and balances",icon:a(ze,{className:"w-8 h-8"}),variant:"gradient",actionButtons:[{label:"Add Leave",icon:a(Ie,{className:"w-4 h-4"}),onPress:()=>A("add_leave"),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"},{label:"Current Year",icon:a(B,{className:"w-4 h-4"}),onPress:()=>q("year",new Date().getFullYear()),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"},{label:"Refresh",icon:a(V,{className:"w-4 h-4"}),onPress:v,className:"bg-gradient-to-r from-[rgba(var(--theme-success-rgb),0.8)] to-[rgba(var(--theme-success-rgb),1)] text-white font-medium hover:opacity-90"}],children:u("div",{className:"p-6",children:[a("div",{className:"mb-6",children:u("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-end",children:[a("div",{className:"w-full sm:w-auto sm:min-w-[200px]",children:a(we,{label:"Select Year",variant:"bordered",selectedKeys:[String(i.year)],onSelectionChange:e=>{const r=Array.from(e)[0];r&&q("year",Number(r))},startContent:a(B,{className:"w-4 h-4"}),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15",popoverContent:"bg-white/10 backdrop-blur-lg border-white/20"},size:x?"sm":"md",children:re.map(e=>a(Ne,{value:e.value,children:e.label},e.key))})}),a("div",{className:"flex gap-2",children:a(Ce,{variant:"flat",color:"primary",size:x?"sm":"md",onPress:v,isLoading:G,startContent:!G&&!H&&a(V,{className:"w-4 h-4"}),children:"Refresh"})})]})}),u("div",{className:"mb-6",children:[u(g,{variant:"h6",className:"mb-4 flex items-center gap-2",children:[a(ee,{className:"w-5 h-5"}),"Leave Balance Summary"]}),fe()]}),u("div",{className:"min-h-96",children:[u(g,{variant:"h6",className:"mb-4 flex items-center gap-2",children:[a(B,{className:"w-5 h-5"}),"Leave History"]}),H?a(M,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(F,{className:"text-center py-12",children:[a(Re,{size:40}),a(g,{className:"mt-4",color:"textSecondary",children:"Loading leave data..."})]})}):Q?a(M,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(F,{className:"text-center py-12",children:[a(Ee,{className:"w-16 h-16 mx-auto mb-4 text-red-400"}),a(g,{variant:"h6",className:"mb-2",children:"Error Loading Data"}),a(g,{color:"textSecondary",children:Q})]})}):y.length>0?a("div",{className:"overflow-hidden rounded-lg",children:a(Ye,{ref:ve,leaves:y,allUsers:_||[],handleClickOpen:se,setCurrentLeave:ne,openModal:A,setLeaves:p,setCurrentPage:ce,currentPage:l.page,totalRows:h,lastPage:I,perPage:l.perPage,selectedMonth:i.selectedMonth,employee:"",isAdminView:!1,fetchLeavesStats:c,updatePaginationMetadata:m,onBulkDelete:ie,canDeleteLeaves:!0})}):a(M,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(F,{className:"text-center py-12",children:[a(B,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),a(g,{variant:"h6",className:"mb-2",children:"No Leave Records Found"}),u(g,{color:"textSecondary",children:["You haven't submitted any leave requests for ",i.year,"."]}),"                      "]})})]})]})})})})]})]})};je.layout=E=>a(Pe,{children:E});export{je as default};
