import{J as be,j as a,a as u,Q as ye,F as V,b as _e}from"./app-D-X2sIvi.js";import{r as s}from"./react-core-DDvupgOx.js";import{d as W}from"./dayjs.min-WGrXCzEl.js";import{G as we}from"./logo-BArjMkSi.js";import{P as Ne}from"./PageHeader-0MgfpcBi.js";import{B as O,f as M,A as Ce}from"./App-xsKFzUM2.js";import{L as X,D as ke,B as xe,a as Le,b as Se}from"./BulkDeleteModal-DzGOuTuD.js";import{a as Z}from"./utilities-DT6SRl8s.js";import{u as Pe,a as K,B as Me,T as g,f as Fe,G as Be}from"./mui-libraries-CyFs7uQU.js";import{F as ee}from"./ChartBarIcon-Yugn57JF.js";import{F as Ye}from"./XCircleIcon-StDWd-mv.js";import{F as Te}from"./PlusIcon-AKF5lePL.js";import{F as De}from"./PresentationChartLineIcon-B_Z8Hogu.js";import{s as Re,l as Ae,b as Ee,g as F,e as B,d as Ie,j as je}from"./ui-libraries-CxFzkmxb.js";import"./EnvelopeIcon-D6nUSkik.js";import"./UserIcon-D16nn9o_.js";import"./ShieldCheckIcon-C7bFKizx.js";import"./ExclamationTriangleIcon-C_gcLnRy.js";import"./TrashIcon-D8Us3Tf_.js";import"./PencilIcon-Dhfhztfv.js";import"./EllipsisVerticalIcon-BX6PWMxg.js";import"./CheckCircleIcon-DnGOlVla.js";import"./ClockIcon-DNQ3nlJB.js";import"./ExclamationTriangleIcon-CsS6HvBt.js";import"./HeartIcon-BSdzzFKC.js";import"./Clear-KUyFCEJA.js";import"./GlassDialog-BVQNy7Op.js";import"./LoadingButton-ZmUpomBU.js";import"./InformationCircleIcon-BNRxDcw3.js";import"./XCircleIcon-DJR5_Dv7.js";import"./CheckCircleIcon-CJUGb5Jf.js";const ze=({title:E,allUsers:_})=>{const{auth:k}=be().props,$=Pe(),x=K($.breakpoints.down("sm")),ae=K($.breakpoints.down("md")),[f,Y]=s.useState(0),[I,T]=s.useState(0),[G,Oe]=s.useState(!1),[y,p]=s.useState([]),[w,N]=s.useState({leaveTypes:[],leaveCountsByUser:{}}),[H,h]=s.useState(!1),[Q,j]=s.useState(""),[l,z]=s.useState({page:1,perPage:30,total:0,lastPage:0}),[i,te]=s.useState({employee:"",selectedMonth:W().format("YYYY-MM"),year:new Date().getFullYear()}),m=s.useCallback(e=>{e&&(Y(e.total||0),T(e.last_page||1),z(r=>({...r,total:e.total||0,lastPage:e.last_page||1})))},[]),v=s.useCallback(async()=>{h(!0);try{const{page:e,perPage:r}=l,{year:t}=i,o=await Z.get(route("leaves.paginate"),{params:{page:e,perPage:r,year:t,user_id:k.user.id},timeout:1e4});if(o.status===200){const{leaves:n,leavesData:d}=o.data;n.data&&Array.isArray(n.data)?(p(n.data),m({total:n.total||n.data.length,last_page:n.last_page||1,current_page:n.current_page||1,per_page:n.per_page||l.perPage})):Array.isArray(n)?(p(n),m({total:n.length,last_page:1,current_page:1,per_page:l.perPage})):(console.error("Unexpected leaves data format:",n),p([]),m({total:0,last_page:1,current_page:1,per_page:l.perPage})),N(d),j("")}}catch(e){if(console.error("Error fetching leaves:",e),e.response?.status===404){const{leavesData:r}=e.response.data;N(r),j(e.response?.data?.message||"No leaves found for the selected criteria.")}else{j("Error retrieving leaves data. Please try again.");const r=Promise.reject("Failed to load leave data. Please try again.");O.promise(r,{error:{render(){return a("div",{children:"Failed to load leave data. Please try again."})},icon:"❌"}})}p([]),m({total:0,last_page:1,current_page:1,per_page:l.perPage})}finally{h(!1)}},[l.page,l.perPage,i,k.user.id,m]),D=s.useCallback((e,r,t)=>{const{page:o,perPage:n}=l;e.length>=n||o<I||v()},[l,I,v]),re=s.useMemo(()=>{const e=new Date().getFullYear();return Array.from({length:e-1900+1},(r,t)=>{const o=1900+t;return{key:o.toString(),label:o.toString(),value:o}}).reverse()},[]),q=s.useCallback((e,r)=>{if(e==="year"){const t=Number(r);if(t<1900||t>new Date().getFullYear()){console.warn("Invalid year selected. Must be between 1900 and current year.");return}}te(t=>({...t,[e]:r})),e==="year"&&z(t=>({...t,page:1}))},[]),[b,R]=s.useState({add_leave:!1,edit_leave:!1,delete_leave:!1,bulk_leave:!1,bulk_delete:!1});s.useCallback((e,r=null)=>{R(t=>({...t,[e]:!0}))},[]);const P=s.useCallback(()=>{R({add_leave:!1,edit_leave:!1,delete_leave:!1,bulk_leave:!1,bulk_delete:!1})},[]),A=s.useCallback(e=>{R(r=>({...r,[e]:!0}))},[]),se=s.useCallback((e,r)=>{U({id:e}),R(t=>({...t,[r]:!0}))},[]),[J,U]=s.useState(null),[le,oe]=s.useState([]),ne=s.useCallback(e=>{U(e)},[]),ie=s.useCallback(e=>{oe(e),A("bulk_delete")},[A]),c=s.useCallback(async()=>{try{const e=await Z.get(route("leaves.stats"),{params:{year:i.year}});if(e.status===200){const{stats:r,leaveCounts:t}=e.data;t&&N(o=>({...o,leaveCountsByUser:{...o.leaveCountsByUser,[k.user.id]:t}}))}}catch(e){console.error("Error fetching leaves stats:",e.response)}},[i.year,k.user.id]),ce=s.useCallback(e=>{e!==l.page&&z(r=>({...r,page:e}))},[l.page]);s.useEffect(()=>{v()},[v]),s.useEffect(()=>{c()},[c]);const de=s.useMemo(()=>w.leaveCountsByUser[k.user.id]||[],[w.leaveCountsByUser,k.user.id]),L=s.useCallback(e=>[...e].sort((r,t)=>new Date(r.from_date)-new Date(t.from_date)),[]),C=s.useCallback(e=>{const r=new Date(e.from_date).getFullYear();if(i.year&&r!==i.year)return!1;if(i.employee){const t=_?.find(n=>String(n.id)===String(e.user_id)),o=i.employee.trim().toLowerCase();if(t){if(String(t.id)!==o&&!(t.name&&t.name.trim().toLowerCase().includes(o)))return!1}else if(String(i.employee)!==String(e.user_id))return!1}if(i.selectedMonth&&W(e.from_date).format("YYYY-MM")!==i.selectedMonth||i.status&&i.status!=="all"&&String(e.status).toLowerCase()!==String(i.status).toLowerCase()||i.leaveType&&i.leaveType!=="all"&&String(e.leave_type).toLowerCase()!==String(i.leaveType).toLowerCase())return!1;if(i.department&&i.department!=="all"){const t=_?.find(o=>String(o.id)===String(e.user_id));if(!t||String(t.department).toLowerCase()!==String(i.department).toLowerCase())return!1}return!0},[i,_]);s.useMemo(()=>y||[],[y]);const ue=s.useCallback(e=>{C(e)&&(h(!0),p(r=>{const t=[...r,e];return L(t).slice(0,l.perPage)}),m({total:f+1,last_page:Math.ceil((f+1)/l.perPage),current_page:l.page,per_page:l.perPage}),h(!1),l.page!==1&&v(),c())},[C,L,l,f,m,v,c]),me=s.useCallback(e=>{if(!e||!e.success){console.error("Invalid bulk response data:",e);return}e.leavesData&&N(e.leavesData);const r=e.created_leaves||[];if(r.length===0){c();return}const t=r.filter(n=>C(n));if(t.length===0){c();return}h(!0),p(n=>{const d=[...n,...t];return L(d).slice(0,l.perPage)});const o=e.summary?.successful||r.length;m({total:f+o,last_page:Math.ceil((f+o)/l.perPage),current_page:l.page,per_page:l.perPage}),h(!1),l.page!==1&&v(),c()},[C,L,l,f,m,v,c]),pe=s.useCallback(e=>{const r=y.some(o=>o.id===e.id);if(h(!0),!C(e)&&r){p(n=>n.filter(d=>d.id!==e.id));const o=Promise.resolve();O.promise(o,{success:{render(){return a("div",{children:"Leave removed from filtered view."})},icon:"ℹ️"}}),h(!1);return}if(!r&&!C(e)){h(!1);return}p(o=>{const n=o.some(S=>S.id===e.id);let d;return n?d=o.map(S=>S.id===e.id?e:S):d=[...o,e],L(d).slice(0,l.perPage)});const t=Promise.resolve();O.promise(t,{success:{render(){return a("div",{children:"Leave updated!"})},icon:"✅"}}),h(!1),l.page!==1&&v(),c()},[C,L,y,l,v,c]),ge=s.useCallback(e=>{p(t=>{const o=t.filter(d=>d.id!==e),n=Math.max(0,f-1);return D(o,n,"delete"),o});const r=Math.max(0,f-1);m({total:r,last_page:Math.max(1,Math.ceil(r/l.perPage)),current_page:l.page,per_page:l.perPage}),c()},[c,f,l,m,D]),fe=s.useCallback(e=>{if(!e||!e.success){console.error("Invalid bulk delete response data:",e);return}e.leavesData&&N(e.leavesData);const r=e.deleted_leaves||[],t=r.map(d=>d.id);if(t.length===0){c();return}h(!0),p(d=>d.filter(S=>!t.includes(S.id)));const o=e.deleted_count||r.length,n=Math.max(0,f-o);m({total:n,last_page:Math.max(1,Math.ceil(n/l.perPage)),current_page:l.page,per_page:l.perPage}),h(!1),D(y.filter(d=>!t.includes(d.id)),n,"delete"),c()},[m,l,f,y,D,c]),he=()=>w.leaveTypes.length?a("div",{className:`grid gap-4 ${x?"grid-cols-1":ae?"grid-cols-2":"grid-cols-4"}`,children:w.leaveTypes.map(({type:e})=>{const r=de.find(d=>d.leave_type===e)||{},t=r.days_used||0,o=r.remaining_days||0,n=t+o;return u(F,{className:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15 transition-all duration-200",children:[a(Ie,{className:"pb-2",children:u("div",{className:"flex items-center gap-2",children:[a(M,{className:"w-5 h-5"}),a(g,{variant:x?"subtitle1":"h6",className:"font-semibold truncate",children:e})]})}),a(B,{className:"pt-0",children:u("div",{className:"space-y-3",children:[u("div",{className:"flex justify-between items-center",children:[u("div",{className:"text-center",children:[a(g,{variant:"caption",color:"textSecondary",children:"Used"}),a(g,{variant:x?"h6":"h5",className:"font-bold text-red-400",children:t})]}),a(je,{orientation:"vertical",className:"h-8"}),u("div",{className:"text-center",children:[a(g,{variant:"caption",color:"textSecondary",children:"Remaining"}),a(g,{variant:x?"h6":"h5",className:"font-bold text-green-400",children:o})]})]}),n>0&&a("div",{className:"w-full bg-gray-200 rounded-full h-2",children:a("div",{className:"bg-gradient-to-r from-red-400 to-orange-400 h-2 rounded-full transition-all duration-300",style:{width:`${t/n*100}%`}})})]})})]},e)})}):a(F,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(B,{className:"text-center py-8",children:[a(ee,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),a(g,{variant:"body1",color:"textSecondary",children:"No leave types available"})]})}),ve=s.useRef(null);return u(_e,{children:[a(ye,{title:E}),b.add_leave&&a(X,{open:b.add_leave,closeModal:()=>P(),leavesData:w,setLeavesData:N,currentLeave:null,allUsers:_,setTotalRows:Y,setLastPage:T,setLeaves:p,employee:"",selectedMonth:i.selectedMonth,addLeaveOptimized:ue,updatePaginationMetadata:m,fetchLeavesStats:c}),b.edit_leave&&a(X,{open:b.edit_leave,closeModal:()=>P(),leavesData:w,setLeavesData:N,currentLeave:J,allUsers:_,setTotalRows:Y,setLastPage:T,setLeaves:p,employee:"",selectedMonth:i.selectedMonth,updateLeaveOptimized:pe,updatePaginationMetadata:m,fetchLeavesStats:c}),b.delete_leave&&a(ke,{open:b.delete_leave,closeModal:()=>P(),leaveId:J?.id,setLeaves:p,setTotalRows:Y,setLastPage:T,deleteLeaveOptimized:ge,updatePaginationMetadata:m,fetchLeavesStats:c}),b.bulk_leave&&a(xe,{open:b.bulk_leave,onClose:()=>P(),onSuccess:e=>{me(e)},allUsers:_,leavesData:w,isAdmin:!1,existingLeaves:y||[],publicHolidays:w?.publicHolidays||[]}),b.bulk_delete&&a(Le,{open:b.bulk_delete,onClose:()=>P(),onSuccess:e=>{fe(e)},selectedLeaves:le,allUsers:_}),u(Me,{sx:{display:"flex",justifyContent:"center",p:2},children:["        ",a(Be,{in:!0,children:a(we,{children:a(Ne,{title:"My Leaves",subtitle:"Your leave requests and balances",icon:a(De,{className:"w-8 h-8"}),variant:"gradient",actionButtons:[{label:"Add Leave",icon:a(Te,{className:"w-4 h-4"}),onPress:()=>A("add_leave"),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"},{label:"Current Year",icon:a(M,{className:"w-4 h-4"}),onPress:()=>q("year",new Date().getFullYear()),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"},{label:"Refresh",icon:a(V,{className:"w-4 h-4"}),onPress:v,className:"bg-gradient-to-r from-[rgba(var(--theme-success-rgb),0.8)] to-[rgba(var(--theme-success-rgb),1)] text-white font-medium hover:opacity-90"}],children:u("div",{className:"p-6",children:[a("div",{className:"mb-6",children:u("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-end",children:[a("div",{className:"w-full sm:w-auto sm:min-w-[200px]",children:a(Re,{label:"Select Year",variant:"bordered",selectedKeys:[String(i.year)],onSelectionChange:e=>{const r=Array.from(e)[0];r&&q("year",Number(r))},startContent:a(M,{className:"w-4 h-4"}),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15",popoverContent:"bg-white/10 backdrop-blur-lg border-white/20"},size:x?"sm":"md",children:re.map(e=>a(Ae,{value:e.value,children:e.label},e.key))})}),a("div",{className:"flex gap-2",children:a(Ee,{variant:"flat",color:"primary",size:x?"sm":"md",onPress:v,isLoading:G,startContent:!G&&!H&&a(V,{className:"w-4 h-4"}),children:"Refresh"})})]})}),u("div",{className:"mb-6",children:[u(g,{variant:"h6",className:"mb-4 flex items-center gap-2",children:[a(ee,{className:"w-5 h-5"}),"Leave Balance Summary"]}),he()]}),u("div",{className:"min-h-96",children:[u(g,{variant:"h6",className:"mb-4 flex items-center gap-2",children:[a(M,{className:"w-5 h-5"}),"Leave History"]}),H?a(F,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(B,{className:"text-center py-12",children:[a(Fe,{size:40}),a(g,{className:"mt-4",color:"textSecondary",children:"Loading leave data..."})]})}):Q?a(F,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(B,{className:"text-center py-12",children:[a(Ye,{className:"w-16 h-16 mx-auto mb-4 text-red-400"}),a(g,{variant:"h6",className:"mb-2",children:"Error Loading Data"}),a(g,{color:"textSecondary",children:Q})]})}):y.length>0?a("div",{className:"overflow-hidden rounded-lg",children:a(Se,{ref:ve,leaves:y,allUsers:_||[],handleClickOpen:se,setCurrentLeave:ne,openModal:A,setLeaves:p,setCurrentPage:ce,currentPage:l.page,totalRows:f,lastPage:I,perPage:l.perPage,selectedMonth:i.selectedMonth,employee:"",isAdminView:!1,fetchLeavesStats:c,updatePaginationMetadata:m,onBulkDelete:ie,canDeleteLeaves:!0})}):a(F,{className:"bg-white/10 backdrop-blur-md border-white/20",children:u(B,{className:"text-center py-12",children:[a(M,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),a(g,{variant:"h6",className:"mb-2",children:"No Leave Records Found"}),u(g,{color:"textSecondary",children:["You haven't submitted any leave requests for ",i.year,"."]}),"                      "]})})]})]})})})})]})]})};ze.layout=E=>a(Ce,{children:E});export{ze as default};
