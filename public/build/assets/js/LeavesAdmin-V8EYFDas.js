import{J as Qe,j as r,a as c,b as ce,Q as Ke}from"./app-DjI6bQiW.js";import{r as l}from"./react-core-DDvupgOx.js";import{G as ue}from"./logo-DSXS0XYv.js";import{P as Ve}from"./PageHeader-LtALPHHB.js";import{S as We}from"./StatsCards-XKPYcq1T.js";import{B as R,e as He,f as ae,A as Je}from"./App-DqZqZbID.js";import{L as me,D as Xe,B as Ze,a as Ue,b as ea}from"./BulkDeleteModal-QGxHmL8I.js";import{d as pe}from"./dayjs.min-WGrXCzEl.js";import{a as G}from"./utilities-DT6SRl8s.js";import{u as aa,a as ve,T as A,B as he,G as ta,F as ra,f as sa}from"./mui-libraries-CyFs7uQU.js";import{F as la}from"./CheckCircleIcon-CJUGb5Jf.js";import{F as oa}from"./XCircleIcon-DJR5_Dv7.js";import{F as ge}from"./ChartBarIcon-Yugn57JF.js";import{F as fe}from"./ExclamationTriangleIcon-C_gcLnRy.js";import{F as na}from"./MagnifyingGlassIcon-yCnY2aj3.js";import{F as ia}from"./AdjustmentsHorizontalIcon-DKS_UuIh.js";import{F as da}from"./PlusIcon-AKF5lePL.js";import{F as ca}from"./DocumentArrowDownIcon-Cq-JO3FQ.js";import{F as ua}from"./PresentationChartLineIcon-B_Z8Hogu.js";import{e as H,i as be,D as ma,b as pa,s as te,l as B,f as J,g as re}from"./ui-libraries-CxFzkmxb.js";import"./EnvelopeIcon-D6nUSkik.js";import"./UserIcon-D16nn9o_.js";import"./ShieldCheckIcon-C7bFKizx.js";import"./TrashIcon-D8Us3Tf_.js";import"./PencilIcon-Dhfhztfv.js";import"./EllipsisVerticalIcon-BX6PWMxg.js";import"./XCircleIcon-StDWd-mv.js";import"./CheckCircleIcon-DnGOlVla.js";import"./ClockIcon-DNQ3nlJB.js";import"./ExclamationTriangleIcon-CsS6HvBt.js";import"./HeartIcon-BSdzzFKC.js";import"./Clear-BeQlK-6X.js";import"./GlassDialog-Bt6xcnNg.js";import"./LoadingButton-ZmUpomBU.js";import"./InformationCircleIcon-BNRxDcw3.js";const va=({title:X,allUsers:_})=>{const{auth:D}=Qe().props,N=aa(),Q=ve(N.breakpoints.down("sm"));ve(N.breakpoints.down("md"));const[ye,Z]=l.useState(!1),[x,j]=l.useState([]),[u,v]=l.useState(),[P,m]=l.useState(0),[we,C]=l.useState(0),[se,le]=l.useState(),[ke,oe]=l.useState([]),[ne,E]=l.useState(""),[O,_e]=l.useState([]),[d,L]=l.useState({perPage:30,currentPage:1}),[ha,F]=l.useState(!1),[K,Pe]=l.useState(!1),[a,Ce]=l.useState({employee:"",selectedMonth:pe().format("YYYY-MM"),status:[],leaveType:[],department:[]}),f=l.useCallback((e,t)=>{if(e==="year"){const s=Number(t);if(s<1900||s>new Date().getFullYear()){console.warn("Invalid year selected. Must be between 1900 and current year.");return}}Ce(s=>({...s,[e]:t})),L(s=>({...s,currentPage:1}))},[]),[z,Le]=l.useState({pending:0,approved:0,rejected:0,total:0}),$=D.permissions?.includes("leaves.view")||!1,Y=D.permissions?.includes("leaves.approve")||!1,ie=D.permissions?.includes("leaves.create")||!1,Se=D.permissions?.includes("leaves.update")||!1,Ae=D.permissions?.includes("leaves.delete")||!1,Me=l.useMemo(()=>{const e=[{key:"all",label:"All Types",value:"all"}];if(!x.leaveTypes)return e;const t=x.leaveTypes.map(s=>({key:s.type.toLowerCase(),label:s.type,value:s.type.toLowerCase()}));return[...e,...t]},[x.leaveTypes]),Ne=l.useCallback(e=>{I(t=>({...t,[e]:!0}))},[]),xe=l.useCallback((e,t)=>{le({id:e}),I(s=>({...s,[t]:!0}))},[]);l.useCallback(e=>{f("employee",e.target.value.toLowerCase())},[f]);const U=l.useCallback(e=>{f("selectedMonth",e.target.value)},[f]),Fe=l.useCallback(e=>{L(t=>({...t,currentPage:e}))},[]),Te=l.useCallback(e=>{L(t=>({...t,perPage:e,currentPage:1}))},[]),h=l.useCallback(async(e=null,t=null)=>{Z(!0);const s=e||d.currentPage,i=t||d.perPage;try{const n=await G.get(route("leaves.paginate"),{params:{page:s,perPage:i,employee:a.employee,month:a.selectedMonth,status:Array.isArray(a.status)&&a.status.length>0?a.status:void 0,leave_type:Array.isArray(a.leaveType)&&a.leaveType.length>0?a.leaveType:void 0,department:Array.isArray(a.department)&&a.department.length>0?a.department:void 0,admin_view:!0,view_all:!0}});if(n.status===200){const{leaves:o,leavesData:b,departments:p}=n.data;o?.data&&Array.isArray(o.data)?(v(o.data),m(o.total||o.data.length),C(o.last_page||1),e&&e!==d.currentPage&&L(g=>({...g,currentPage:e})),t&&t!==d.perPage&&L(g=>({...g,perPage:t}))):Array.isArray(o)?(v(o),m(o.length),C(1)):(console.error("Unexpected leaves data format:",o),v([]),m(0),C(1)),j(b),_e(p||[]),E("")}}catch(n){if(console.error("Error fetching leaves data:",n.response),n.response?.status===404){const{leavesData:o}=n.response.data||{};j(o||[]),E(n.response?.data?.message||"No leaves found for the selected criteria.")}else E(n.response?.data?.message||"Error retrieving leaves data. Please try again.");v([]),m(0),C(1)}finally{Z(!1)}},[a,d.currentPage,d.perPage]),S=l.useCallback(async()=>{try{const e=await G.get(route("leaves.stats"),{params:{month:a.selectedMonth,admin_view:!0,view_all:!0}});if(e.status===200){const{stats:t}=e.data;Le(t)}}catch(e){console.error("Error fetching leaves data:",e.response),e.response?.status===404?E(e.response?.data?.message||"No leaves found for the selected criteria."):E("Error retrieving leaves data. Please try again."),Z(!1)}},[a]),Re=l.useCallback(async e=>{if(Y)try{if((await G.post(route("leaves.bulk-approve"),{leave_ids:e})).status===200){h();const s=Promise.resolve();R.promise(s,{success:"Selected leaves approved successfully"})}}catch(t){console.error("Error bulk approving leaves:",t);const s=Promise.reject(t);R.promise(s,{error:"Failed to approve selected leaves"})}},[Y,h]),Be=l.useCallback(async e=>{if(Y)try{if((await G.post(route("leaves.bulk-reject"),{leave_ids:e})).status===200){h();const s=Promise.resolve();R.promise(s,{success:"Selected leaves rejected successfully"})}}catch(t){console.error("Error bulk rejecting leaves:",t);const s=Promise.reject(t);R.promise(s,{error:"Failed to reject selected leaves"})}},[Y,h]),De=l.useCallback(e=>{oe(e),I(t=>({...t,bulk_delete:!0}))},[]),je=l.useMemo(()=>[{title:"Pending",value:z.pending,icon:r(He,{}),color:"text-orange-400",iconBg:"bg-orange-500/20",description:"Awaiting approval"},{title:"Approved",value:z.approved,icon:r(la,{}),color:"text-green-400",iconBg:"bg-green-500/20",description:"Successfully approved"},{title:"Rejected",value:z.rejected,icon:r(oa,{}),color:"text-red-400",iconBg:"bg-red-500/20",description:"Declined requests"},{title:"Total",value:z.total,icon:r(ge,{}),color:"text-blue-400",iconBg:"bg-blue-500/20",description:"All leave requests"}],[z]);if(!$)return r(he,{sx:{display:"flex",justifyContent:"center",p:2},children:r(ue,{children:c(H,{className:"p-8 text-center",children:[r(fe,{className:"w-16 h-16 text-warning-500 mx-auto mb-4"}),r(A,{variant:"h6",className:"mb-2",children:"Access Denied"}),r(A,{variant:"body2",color:"textSecondary",children:"You don't have permission to view leave management."})]})})});const[y,I]=l.useState({add_leave:!1,edit_leave:!1,delete_leave:!1,bulk_leave:!1,bulk_delete:!1}),Ee=l.useRef(null),de=l.useCallback(e=>{I(t=>({...t,[e]:!0}))},[]),q=l.useCallback(e=>{I(t=>({...t,[e]:!1})),e==="bulk_delete"&&oe([])},[]),V=l.useCallback(e=>[...e].sort((t,s)=>new Date(s.from_date)-new Date(t.from_date)),[]),M=l.useCallback((e,t=null)=>{m(e);const s=Math.max(1,Math.ceil(e/d.perPage));C(s),d.currentPage>s&&L(i=>({...i,currentPage:s}))},[d.perPage,d.currentPage]),W=l.useCallback(e=>{const t=pe(e.from_date).format("YYYY-MM");if(a.selectedMonth&&t!==a.selectedMonth)return!1;if(a.employee){const s=_?.find(n=>String(n.id)===String(e.user_id)),i=a.employee.trim().toLowerCase();if(s){if(String(s.id)!==i&&!(s.name&&s.name.trim().toLowerCase().includes(i)))return!1}else if(String(a.employee)!==String(e.user_id))return!1}if(Array.isArray(a.status)&&a.status.length>0&&!a.status.some(i=>String(e.status).toLowerCase()===String(i).toLowerCase())||Array.isArray(a.leaveType)&&a.leaveType.length>0&&!a.leaveType.some(i=>String(e.leave_type).toLowerCase()===String(i).toLowerCase()))return!1;if(Array.isArray(a.department)&&a.department.length>0){const s=_?.find(n=>String(n.id)===String(e.user_id));if(!s||!a.department.some(n=>String(s.department_id)===String(n)))return!1}return!0},[a,_]),Oe=l.useMemo(()=>u||[],[u]),ee=l.useCallback(async()=>{if(u&&u.length<d.perPage&&P>u.length){const e=Math.min(d.perPage-u.length,P-u.length);if(e<=0)return;F(!0);try{const t=await G.get(route("leaves.paginate"),{params:{page:d.currentPage+1,perPage:e,employee:a.employee,month:a.selectedMonth,status:Array.isArray(a.status)&&a.status.length>0?a.status:void 0,leave_type:Array.isArray(a.leaveType)&&a.leaveType.length>0?a.leaveType:void 0,department:Array.isArray(a.department)&&a.department.length>0?a.department:void 0,admin_view:!0,view_all:!0}});t.status===200&&t.data.leaves.data&&v(s=>{const i=t.data.leaves.data.filter(W),n=[...s,...i];return V(n)})}catch(t){const s=Promise.reject(t);R.promise(s,{error:"Error fetching additional items."}),console.error(`Error fetching additional items from page ${d.currentPage+1}:`,t)}finally{F(!1)}}},[d.currentPage,d.perPage,u,a,V,W]),w=l.useCallback((e,t)=>{if(!t||!t.success){console.error(`Invalid ${e} response data:`,t);return}S(),t.leavesData&&j(t.leavesData);const s=d.perPage,i=d.currentPage;switch(e){case"bulk_delete":{const n=t.deleted_leaves||[],o=t.deleted_count||n.length;if(o===0)return;const b=n.map(k=>k.id),p=Math.max(0,P-o),g=u.filter(k=>!b.includes(k.id)).length;if(o>5||g===0||i>1&&g<s/2){const k=Math.ceil(p/s);let T=i;g===0&&p>0?T=Math.max(1,i-1):i>k&&k>0&&(T=k),L(Ge=>({...Ge,currentPage:T})),h(T,s)}else F(!0),v(k=>k.filter(T=>!b.includes(T.id))),m(p),M(p),F(!1),ee();break}case"single_delete":{const n=t.deleted_leave_id;if(!n)return;const o=Math.max(0,P-1);if(u.filter(p=>p.id!==n).length===0&&o>0&&i>1){const p=i-1;L(g=>({...g,currentPage:p})),h(p,s)}else F(!0),v(p=>p.filter(g=>g.id!==n)),m(o),M(o),F(!1),ee();break}case"bulk_add":{const n=t.added_count||1,o=P+n;m(o),M(o),h(i,s);break}case"single_add":{const n=t.added_count||1,o=P+n,b=t.leave;if(b&&W(b))if(u.length<s){const g=V([...u,b]);v(g),m(o),M(o)}else m(o),M(o),h(i,s);else m(o),M(o);break}case"edit":{const n=t.updated_leave||t.leave;n&&v(o=>o.map(b=>b.id===n.id?n:b));break}}},[d.perPage,d.currentPage,P,u,S,M,h,ee,W,V]),ze=l.useCallback(e=>{w("single_add",{success:!0,added_count:1,leave:e})},[w]),$e=l.useCallback(e=>{w("edit",{success:!0,updated_leave:e});const s=Promise.resolve(["Leave updated!"]);R.promise(s,{success:{render({data:i}){return r(ce,{children:i.map((n,o)=>r("div",{children:n},o))})},icon:"🟢",style:{backdropFilter:"blur(16px) saturate(200%)",background:N.glassCard.background,border:N.glassCard.border,color:N.palette.text.primary}}})},[h,S,N]),Ye=l.useCallback(e=>{if(!e||!e.success){console.error("Invalid bulk response data:",e);return}const t=e.created_leaves||[],s=e.summary?.successful||t.length,i={...e,added_count:s};w("bulk_add",i)},[w]),Ie=l.useCallback(e=>{w("single_delete",{success:!0,deleted_leave_id:e})},[w]),qe=l.useCallback(e=>{w("bulk_delete",e)},[w]);return l.useEffect(()=>{$&&h()},[h,$,d.currentPage,a.employee,a.selectedMonth,a.status,a.leaveType,a.department]),l.useEffect(()=>{$&&S()},[h,$]),c(ce,{children:[r(Ke,{title:X}),y.add_leave&&r(me,{open:y.add_leave,closeModal:()=>q("add_leave"),leavesData:x,setLeavesData:j,currentLeave:null,allUsers:_,departments:O,setTotalRows:m,setLastPage:C,setLeaves:v,handleMonthChange:U,employee:a.employee,selectedMonth:a.selectedMonth,addLeaveOptimized:ze,fetchLeavesStats:S}),y.edit_leave&&r(me,{open:y.edit_leave,closeModal:()=>q("edit_leave"),leavesData:x,setLeavesData:j,currentLeave:se,allUsers:_,departments:O,setTotalRows:m,setLastPage:C,setLeaves:v,handleMonthChange:U,employee:a.employee,selectedMonth:a.selectedMonth,updateLeaveOptimized:$e,fetchLeavesStats:S}),y.delete_leave&&r(Xe,{open:y.delete_leave,closeModal:()=>q("delete_leave"),leaveId:se?.id,setLeaves:v,setTotalRows:m,setLastPage:C,deleteLeaveOptimized:Ie,fetchLeavesStats:S}),y.bulk_leave&&r(Ze,{open:y.bulk_leave,onClose:()=>q("bulk_leave"),onSuccess:e=>{Ye(e)},allUsers:_,departments:O,leavesData:x,isAdmin:!0}),y.bulk_delete&&r(Ue,{open:y.bulk_delete,onClose:()=>q("bulk_delete"),onSuccess:e=>{qe(e)},selectedLeaves:ke,allUsers:_}),r(he,{sx:{display:"flex",justifyContent:"center",p:2},children:r(ta,{in:!0,children:r(ue,{children:r(Ve,{title:"Leave Management",subtitle:"Manage employee leave requests and approvals",icon:r(ua,{className:"w-8 h-8"}),variant:"gradient",actionButtons:[...ie?[{label:"Add Leave",icon:r(da,{className:"w-4 h-4"}),onPress:()=>de("add_leave"),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"}]:[],...ie?[{label:"Add Bulk",icon:r(ae,{className:"w-4 h-4"}),onPress:()=>de("bulk_leave"),className:"bg-gradient-to-r from-[var(--theme-primary)] to-[var(--theme-secondary)] text-white font-medium hover:opacity-90"}]:[],{label:"Export",icon:r(ca,{className:"w-4 h-4"}),variant:"bordered",className:"border-[rgba(var(--theme-primary-rgb),0.3)] bg-[rgba(var(--theme-primary-rgb),0.05)] hover:bg-[rgba(var(--theme-primary-rgb),0.1)]"}],children:c("div",{className:"p-6",children:[r(We,{stats:je}),c("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[r("div",{className:"flex-1",children:r(be,{label:"Search Employee",variant:"bordered",placeholder:"Search by name or ID...",value:a.employee,onValueChange:e=>f("employee",e),startContent:r(na,{className:"w-4 h-4"}),classNames:{input:"bg-transparent",inputWrapper:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},size:Q?"sm":"md"})}),r("div",{className:"flex gap-2 items-end",children:r(ma,{variant:"bordered",className:"bg-white/5",children:c(pa,{isIconOnly:Q,color:K?"primary":"default",onPress:()=>Pe(!K),className:K?"bg-purple-500/20":"bg-white/5",children:[r(ia,{className:"w-4 h-4"}),!Q&&r("span",{className:"ml-1",children:"Filters"})]})})})]}),K&&r(ra,{in:!0,timeout:300,children:c("div",{className:"mb-6 p-4 bg-white/5 backdrop-blur-md rounded-lg border border-white/10",children:[c("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[c(te,{label:"Leave Status",selectionMode:"multiple",variant:"bordered",selectedKeys:a.status,onSelectionChange:e=>f("status",Array.from(e)),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},children:[r(B,{value:"pending",children:"Pending"},"pending"),r(B,{value:"approved",children:"Approved"},"approved"),r(B,{value:"rejected",children:"Rejected"},"rejected"),r(B,{value:"new",children:"New"},"new")]}),r(te,{label:"Leave Type",variant:"bordered",selectionMode:"multiple",selectedKeys:a.leaveType,onSelectionChange:e=>f("leaveType",Array.from(e)),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},children:Me.map(e=>r(B,{value:e.value,children:e.label},e.key))}),r(te,{label:"Department",variant:"bordered",selectionMode:"multiple",selectedKeys:a.department,onSelectionChange:e=>f("department",Array.from(e)),classNames:{trigger:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},children:O.map(e=>r(B,{value:e.id,children:e.name},e.id))}),r(be,{label:"Month/Year",type:"month",value:a.selectedMonth,onChange:U,startContent:r(ae,{className:"w-4 h-4"}),variant:"bordered",classNames:{inputWrapper:"bg-white/10 backdrop-blur-md border-white/20 hover:bg-white/15"},size:Q?"sm":"md"})]}),(a.employee||Array.isArray(a.status)&&a.status.length>0||Array.isArray(a.leaveType)&&a.leaveType.length>0||Array.isArray(a.department)&&a.department.length>0)&&c("div",{className:"flex flex-wrap gap-2 mt-4 pt-4 border-t border-white/10",children:[a.employee&&c(J,{variant:"flat",color:"primary",size:"sm",onClose:()=>f("employee",""),children:["Employee: ",a.employee]}),Array.isArray(a.status)&&a.status.map(e=>c(J,{variant:"flat",color:"secondary",size:"sm",onClose:()=>f("status",a.status.filter(t=>t!==e)),children:["Status: ",e]},e)),Array.isArray(a.leaveType)&&a.leaveType.map(e=>c(J,{variant:"flat",color:"warning",size:"sm",onClose:()=>f("leaveType",a.leaveType.filter(t=>t!==e)),children:["Type: ",e]},e)),Array.isArray(a.department)&&a.department.map(e=>{const t=O.find(s=>String(s.id)===String(e));return c(J,{variant:"flat",color:"success",size:"sm",onClose:()=>f("department",a.department.filter(s=>s!==e)),children:["Department: ",t?.name||`ID: ${e}`]},e)})]})]})}),c("div",{className:"min-h-96",children:[c(A,{variant:"subtitle1",component:"div",className:"mb-4 flex items-center gap-2 font-semibold",children:[r(ge,{className:"w-5 h-5"}),"Leave Requests Management"]}),ye?r(re,{className:"bg-white/10 backdrop-blur-md border-white/20",children:c(H,{className:"text-center py-12",children:[r(sa,{size:40}),r(A,{className:"mt-4",color:"textSecondary",children:"Loading leave data..."})]})}):u&&u.length>0?r("div",{className:"overflow-hidden rounded-lg",children:r(ea,{ref:Ee,totalRows:P,lastPage:we,setCurrentPage:Fe,setPerPage:Te,perPage:d.perPage,currentPage:d.currentPage,handleClickOpen:xe,setCurrentLeave:le,openModal:Ne,leaves:Oe,allUsers:_,setLeaves:v,employee:a.employee,selectedMonth:a.selectedMonth,isAdminView:!0,onBulkApprove:Re,onBulkReject:Be,canApproveLeaves:Y,canEditLeaves:Se,canDeleteLeaves:Ae,fetchLeavesStats:S,onBulkDelete:De})}):ne?r(re,{className:"bg-white/10 backdrop-blur-md border-white/20",children:c(H,{className:"text-center py-12",children:[r(fe,{className:"w-16 h-16 text-warning-500 mx-auto mb-4"}),r(A,{variant:"subtitle1",component:"div",className:"mb-2 font-semibold",children:"No Data Found"}),r(A,{color:"textSecondary",children:ne})]})}):r(re,{className:"bg-white/10 backdrop-blur-md border-white/20",children:c(H,{className:"text-center py-12",children:[r(ae,{className:"w-16 h-16 text-default-400 mx-auto mb-4"}),r(A,{variant:"subtitle1",component:"div",className:"mb-2 font-semibold",children:"No Leave Records Found"}),r(A,{color:"textSecondary",children:"No leave records found for the selected criteria."})]})})]})]})})})})})]})};va.layout=X=>r(Je,{children:X});export{va as default};
